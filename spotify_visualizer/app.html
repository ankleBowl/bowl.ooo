<!DOCTYPE html>
<head>
    <title>Spotify Fullscreen Player</title>
    <meta charset="utf-8">
    <style>
        @import url("https://use.typekit.net/jmr4hbb.css");

        body {
            position: relative;
            margin: 0;
            width: 100vw;
            height: 100vh;

            /* background-color: gray; */

            font-family: 'SF Pro Display', 'Filson Pro' , 'Helvetica Neue', 'Helvetica', 'Arial', sans-serif;
        }

        #glcanvas {
            width: 100%;
            height: 100%;

            filter: blur(10px) contrast(110%) saturate(2) brightness(65%)
        }

        /* preblur image while respeting contrast tso that i can use a lesser blur here */

        #canvasContainer {
            position: fixed;
            left: -15%;
            top: -15%;
            right: -15%;
            bottom: -15%;
    
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 50px;



        }

        #main-container {
            position: fixed;
            width: 100%;
            height: 100%;

            display: flex;
            box-sizing: border-box;
            align-items: center;
            justify-content: center;
            padding: 0 6vw;

            transition: gap 0.25s ease-out;
        }

        #main-container > div {
            height: 100%;
        }

        #now-playing-view {
            flex: 0.75;
            
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;

            max-width: calc(485px + 6.5vw);

            text-align: center;

            transition: max-width 0.25s ease-out;
        }

        #album-art-container {
            width: 100%;
            aspect-ratio: 1;

            position: relative;
            box-shadow: 0 0 40px 0px rgba(0, 0, 0, 0.15);

            border-radius: 10px;
            overflow: hidden;
            
        }

        #album-art-container > img {
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;

            width: 100%;

            background-color: red;

            transition: opacity 0.5s ease-out;
        }

        #now-playing-info {
            position:relative;

            width: 96%;
            height: 0;
        }   

        #now-playing-info > div {
            position: absolute;
            margin-top: 3vw;
            left: 0;
            right: 0;
        }

        #progress-bar-container {
            width: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 12px;
        }

        #progress-times {
            display: flex;
            width: 98%;
            justify-content: space-between;
            font-size: 0.7em;
            font-weight: bold;
        }

        #progress-bar {
            width: 98%;
            height: 3.5px;
            border-radius: 3px;
            overflow: hidden;
            background-color: rgba(255, 255, 255, 0.4);
        }

        #progress-bar > div {
            width: 50%;
            height: 100%;
            background-color: white;
            border-radius: 3px;
        }


        
        #song-info {
            margin-top: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;

            position: relative;
        }


        p {
            color: rgba(255, 255, 255, 0.4);
            margin: 0;

            font-size: 1.3em;

        }

        #title {
            color: white;
            font-weight: bold;
            font-size: 1.2em;
            transition: opacity 0.15s ease-out;
        }

        #metadata {
            transition: opacity 0.15s ease-out;
        }


        /* FOR WHEN LYRICS ARE VISIBLE */
        .lyrics-visible #now-playing-view {
            max-width: calc(465px + 6.5vw);
        }

        .lyrics-visible #lyrics-view {
            width: 40vw;
        }

        .lyrics-visible {
            gap: 100px;
        }

        #lyrics-view {
            width: 0;
            overflow: hidden;
            box-sizing: border-box;
            position: relative;
            mask-image: linear-gradient(rgba(0, 0, 0, 0), black 50%, rgba(0, 0, 0, 0));
            transition: opacity 0.5s ease-out, width 0.25s ease-out;
            height: 100%;
        }

        #lyrics-view > p {
            /* font-size: 3.1em; */
            font-size: calc(1.2em + 1.5vw);

            position: absolute;

            right: 6%;
            left: 8%;

            font-weight: bold;

            transition: top 0.2s ease-in-out, opacity 0.2s ease-out, color 0.2s ease-out;

            cursor: pointer;
            
        }

        #lyrics-view > p:hover {
            color: rgba(255, 255, 255, 0.8) !important;
        }

        #lyrics-view > * {
            position: absolute;
            right: 8%;
            left: 8%;
            transition: top 0.2s ease-in-out, opacity 0.2s ease-out, color 0.2s ease-out;
        }

        #lyrics-view > .song-pause {
            display: flex;
            flex-direction: row;
            gap: 10px;
            height: 30px;
        }

        #lyrics-view > .song-pause > div {
            height: 18px;
            width: 18px;
            background-color: rgba(255, 255, 255, 0.4);
            border-radius: 100%;

            transition: background-color 0.2s linear;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        @keyframes fadeOut {
            from {
                opacity: 1;
            }
            to {
                opacity: 0;
            }
        }

        #playback-controls {
            position: absolute;

            left: 0;
            right: 0;
            top: 0;
            bottom: 0;

            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 30px;

            transition: opacity 0.15s ease-out;
        }

        #playback-controls > div {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0px;
        }

        #playback-controls button {
            display: flex;
            align-items: center;
            justify-content: center;
            
            border-radius: 10px;
            border: none;
            background: none;


            height: 40px;
            aspect-ratio: 1;
            
            opacity: 0.4;
        }
        
        #playback-controls button:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

    </style>
</head>
<body onload="start()">
    
    <!-- <div style="position: fixed; top: 0; left: 0; width: 100vw; height: 100vw; z-index: 1; opacity: 0.5; display: flex; justify-content: center;">
        <img src="/169lyrics.png" style="height: 100vh;">
    </div> -->

    <div id="canvasContainer">
        <canvas id="glcanvas"></canvas>
    </div>

    <div id="main-container">
        <div id="now-playing-view">
            <div id="album-art-container">
                <img id="album-art-one" crossorigin="anonymous">
                <img id="album-art-two" crossorigin="anonymous">
            </div>
            
            <div id="now-playing-info">
                <div class="song-info">
                    <div id="progress-bar-container">
                        <div id="progress-times">
                            <p>0:01</p>
                            <p>2:49</p>
                        </div>
                        <div id="progress-bar">
                            <div></div>
                        </div>
                    </div>
                    <div id="song-info">
                        <p id="title" class="highlighted">Gurenge</p>
                        <p id="metadata">LiSA — Gurenge - EP</p>
                        <div id="playback-controls">
                            <div>
                                <!-- <button></button> -->
                            </div>
                            <div>
                                <button onclick="skipToPrevious()"><img src="skip.svg"></button>
                                <button onclick="togglePlayback()"><img src="pause.svg"></button>
                                <button onclick="skipToNext()" style="transform: scaleX(-100%)"><img src="skip.svg"></button>
                            </div>
                            <div>
                                <!-- <button></button> -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div id="lyrics-view">

        </div>
    </div>

</body>
<script>

    const clientId = '13a58573df5945fb9bf1bd8f8401d47b';
    const redirectUri = window.location.origin + window.location.pathname;
    console.log(redirectUri);
    const scope = 'user-read-playback-state user-library-read user-modify-playback-state';

    const generateRandomString = (length) => {
        const possible = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
        const values = crypto.getRandomValues(new Uint8Array(length));
        return values.reduce((acc, x) => acc + possible[x % possible.length], "");
    }
    const sha256 = async (plain) => {
        const encoder = new TextEncoder()
        const data = encoder.encode(plain)
        return window.crypto.subtle.digest('SHA-256', data)
    }
    const base64encode = (input) => {
        return btoa(String.fromCharCode(...new Uint8Array(input)))
            .replace(/=/g, '')
            .replace(/\+/g, '-')
            .replace(/\//g, '_');
    }
    
    const getToken = async code => {
        let codeVerifier = localStorage.getItem('code_verifier');

        const payload = {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: new URLSearchParams({
                client_id: clientId,
                grant_type: 'authorization_code',
                code,
                redirect_uri: redirectUri,
                code_verifier: codeVerifier,
            }),
        }
        let url = 'https://accounts.spotify.com/api/token';
        const body = await fetch(url, payload);
        const response =await body.json();
        if (response.error) {
            throw new Error(response.error_description);
        }
        localStorage.setItem('access_token', response.access_token);
    }

    async function signInToSpotify() {
        const codeVerifier  = generateRandomString(64);
        const hashed = await sha256(codeVerifier)
        const codeChallenge = base64encode(hashed);

        const authUrl = new URL("https://accounts.spotify.com/authorize")

        window.localStorage.setItem('code_verifier', codeVerifier);

        const params =  {
            response_type: 'code',
            client_id: clientId,
            scope,
            code_challenge_method: 'S256',
            code_challenge: codeChallenge,
            redirect_uri: redirectUri,
        }

        authUrl.search = new URLSearchParams(params).toString();
        window.location.href = authUrl.toString();
    }
    
    async function connect() {
        const urlParams = new URLSearchParams(window.location.search);
        let code = urlParams.get('code');
        try {
            await getToken(code);
            updateView();
            setInterval(() => {
                updateView();
            }, SPOTIFY_POLL_RATE);
        } catch (e) {
            signInToSpotify();
        }
    }
    
</script>
<script>
    let lyricsEnabled = true;

    function toggleLyrics() {
        lyricsEnabled = !lyricsEnabled;
        if (lyricsEnabled) {
            showLyrics();
        } else {
            hideLyrics();
        }
    }

    let currentLyricIndex = 0;
    let prevAlbumArtUrl = null;
    let prevSongId = null;
    let activeTexture = "u_texture_one";
    let activeAlbumArtId = "album-art-one";
    async function updateView() {
        // console.log('Updating view...');
        let currentlyPlaying = await getCurrentlyPlaying();
        if (!currentlyPlaying) {
            currentlyPlaying = {
                sondId: null,
                songName: '',
                artistName: null,
                albumName: null,
                currentPlaybackTime: null,
                totalSongLength: null,
                albumArtUrl: 'no_song.svg'
            }   
        }

        if (currentlyPlaying.albumArtUrl == prevAlbumArtUrl) {
            currentlyPlaying.albumArtUrl = null
        } else {
            prevAlbumArtUrl = currentlyPlaying.albumArtUrl;
        }
        // console.log('Updating view with currently playing track:', currentlyPlaying);
        playSong(currentlyPlaying.songId, currentlyPlaying.songName, currentlyPlaying.albumName, currentlyPlaying.artistName, currentlyPlaying.currentPlaybackTime, currentlyPlaying.totalSongLength, currentlyPlaying.albumArtUrl);
    }

    function fadeOutLyrics(lyricLines) {
        let lyricsView = document.getElementById("lyrics-view");
        setTimeout(() => {
            lyricsView.style.opacity = 0;
        }, 500);
        let fadeOutStartFrom = -1
        for (let i = 0; i < lyricsView.children.length; i++) {
            let lyric = lyricsView.children[i];
            if (lyric.style.opacity == 1) {
                fadeOutStartFrom = i;
                break;
            }
        }
        if (fadeOutStartFrom == -1 || fadeOutStartFrom >= lyricsView.children.length - 1) {
            return;
        }
        for (let i = fadeOutStartFrom; i < lyricsView.children.length; i++) {
            let lyric = lyricsView.children[i];
            if (lyric.style.opacity != 0) {
                lyric.style.animation = `fadeOut 0.5s ease-in-out ${(i - fadeOutStartFrom) * 0.1}s forwards`;
            }

        }
    }


    function fillInLyrics(lyricLines) {
        let lyricsView = document.getElementById("lyrics-view");
        lyricsView.innerHTML = "";

        let currentTop = 0;
        currentLyricIndex = 0;

        let dotsHeight = -1

        for (let i = 0; i < lyricLines.length; i++) {
            // check if line contains ♪
            var elem;
            let isDots = lyricLines[i].text.includes("♪")
            let nextIsDots = (i < lyricLines.length - 1) && lyricLines[i + 1].text.includes("♪");
            if (isDots) {
                elem = document.createElement("div");
                elem.setAttribute("line-type", "dots");
                elem.classList.add("song-pause");

                for (let j = 0; j < 3; j++) {
                    let subElem = document.createElement("div");
                    elem.appendChild(subElem);
                }
            } else {
                elem = document.createElement("p");
                elem.setAttribute("line-type", "lyric");
                elem.innerText = lyricLines[i].text;
                elem.addEventListener("click", () => {
                    
                    lastLastRecognizedPlaytime = lyricLines[i].time * 1000;
                    lastRecognizedPlaytime = lyricLines[i].time * 1000;

                    lastManualPlaytimeChange = Date.now();
                    
                    skipToPosition(lyricLines[i].time * 1000);

                    scrollOffset = 0;
                    scrollLyrics(lyricLines[i].time);
                });
            }

            elem.setAttribute("data-start", lyricLines[i].time);
            lyricsView.appendChild(elem);

            lineHeight = elem.getBoundingClientRect().height;

            LYRICS_PADDING = 40;

            if (!isDots) {
                elem.style.top = `${currentTop}px`;
                elem.setAttribute("data-top", currentTop);
                if (!nextIsDots) {
                    currentTop += lineHeight + LYRICS_PADDING
                } else {
                    dotsHeight = lineHeight;
                }
            } else {
                if (dotsHeight == -1) {
                    elem.style.top = `${currentTop}px`;
                    elem.setAttribute("data-top", currentTop);
                    currentTop += lineHeight + LYRICS_PADDING;
                } else {
                    let currentDotElemHeight = elem.getBoundingClientRect().height;
                    let topOffset = (dotsHeight - currentDotElemHeight)

                    console.log(dotsHeight, currentDotElemHeight, topOffset);

                    elem.style.top = `${currentTop + topOffset}px`;
                    elem.setAttribute("data-top", currentTop + topOffset);
                    currentTop += dotsHeight + 50;
                }
            }
        }

        setTimeout(() => {
            lyricsView.style.opacity = 1;
        }, 100);
    }

    let scrollOffset = 0;
    let lastScroll = -1;

    document.getElementById("lyrics-view").addEventListener("wheel", (e) => {
        e.preventDefault();
        scrollOffset -= e.deltaY;
        lastScroll = Date.now();

        let lyricsView = document.getElementById("lyrics-view");
        let lyricsHeight = lyricsView.children[lyricsView.children.length - 1].getAttribute("data-top");
        let halfHeight = lyricsView.getBoundingClientRect().height / 2;
        if (scrollOffset > heightOffset + halfHeight) {
            scrollOffset = heightOffset + halfHeight;
        }
        if (scrollOffset <= -lyricsHeight + heightOffset + halfHeight) {
            scrollOffset = -lyricsHeight + heightOffset + halfHeight;
        }
        scrollLyrics(estimateCurrentTime());
    });

    let prevTargetLyricIndex = -1;
    let prevHeightOffset = 0;
    let heightOffset;

    function scrollLyrics(time) {
        let lyricsView = document.getElementById("lyrics-view");

        if (lyricsView.children.length == 0) {
            return;
        }

        if (Date.now() - lastScroll > 5000) {
            scrollOffset = 0;
            lastScroll = -1;
        }

        // Find the relevant lyric given the time
        let targetLyricIndex = -1;
        let targetLyric;
        
        for (let i = 0; i < lyricsView.children.length; i++) {
            let lyric = lyricsView.children[i];
            let startTime = parseFloat(lyric.getAttribute("data-start"));
            if (startTime > time) {
                targetLyricIndex = i - 1;
                targetLyric = lyricsView.children[targetLyricIndex];

                let heightDifference = heightOffset - prevHeightOffset;
                prevHeightOffset = heightOffset;
                if (scrollOffset != 0) {
                    scrollOffset += heightDifference;
                }
                
                break;
            } else {
                // offset scroll by the height of this lyric
                heightOffset = parseInt(lyric.getAttribute("data-top"));
                heightOffset -= lyricsView.getBoundingClientRect().height / 2;
                
                // console.log(time)
                // console.log(heightOffset, prevHeightOffset);
                // scrollOffset += (heightOffset - prevHeightOffset);
            }
        }

        heightOffset += targetLyric.getBoundingClientRect().height / 2;

        prevTargetLyricIndex = targetLyricIndex;

        // Set custom transition durations based on distance from target lyric (creates the Apple Music springy effect)
        for (let i = 0; i < lyricsView.children.length; i++) {
            let lyric = lyricsView.children[i];
            let transitionDuration = (Math.abs(i - targetLyricIndex) * 0.1) + 0.3;
            if (scrollOffset == 0) {
                transitionDuration = Math.min(transitionDuration, 0.8);
                lyric.style.transition = `top ${transitionDuration}s cubic-bezier(0.13, -0.003, 0, 1.006), opacity 0.3s ease-out, color 0.3s ease-out`;
            } else {
                lyric.style.transition = `opacity 0.1s linear, color 0.1s linear, top 0.1s linear`;
            }
            
        }

        // Shift all lyrics up or down based on the target lyric
        for (let i = 0; i < lyricsView.children.length; i++) {
            let lyric = lyricsView.children[i];
            let newTop = parseInt(lyric.getAttribute("data-top")) - heightOffset + scrollOffset;

            if (targetLyric.getAttribute("line-type") == "dots" && i == targetLyricIndex - 1) {
                newTop -= lyric.getBoundingClientRect().height;
            }
            lyric.style.top = `${newTop}px`;
        }
        

        // Highlight only the target lyric
        for (let i = 0; i < lyricsView.children.length; i++) {
            let lyric = lyricsView.children[i];
            if (i == targetLyricIndex) {
                lyric.style.color = "white";
                lyric.style.opacity = 1;
            } else if (i > targetLyricIndex) {
                lyric.style.color = "rgba(255, 255, 255, 0.4)";
                lyric.style.opacity = 1;
            } else {    
                if (scrollOffset == 0) {
                    lyric.style.opacity = 0;
                } else {
                    lyric.style.opacity = 1;
                    lyric.style.color = "rgba(255, 255, 255, 0.4)";
                }
                
            }

            if (i != targetLyricIndex && lyric.tagName == "DIV") {
                lyric.style.opacity = 0;
            }
        }

        // If the current lyric is a dots line, update it's progress
        if (targetLyric && targetLyric.getAttribute("line-type") == "dots") {
            let nextLyric = lyricsView.children[targetLyricIndex + 1];

            // Update the dots progress
            if (nextLyric) {
                let nextLyricStart = parseFloat(nextLyric.getAttribute("data-start"));
                let thisLyricStart =  parseFloat(targetLyric.getAttribute("data-start"));
                let timeUntilNextLyric = nextLyricStart - time;
                let totalLyricTime = nextLyricStart - thisLyricStart;

                let percentageComplete = 1 - (timeUntilNextLyric / totalLyricTime);
                
                // console.log(percentageComplete);

                let dotIndex = Math.floor(percentageComplete * 3);
                let dotCompletion = percentageComplete * 3 - dotIndex;

                // console.log(dotIndex, dotCompletion);

                for (let i = 0; i < 3; i++) {
                    let dot = targetLyric.children[i];
                    if (i == dotIndex) {
                        dotCompletion = dotCompletion * 0.6 + 0.4;
                        dot.style.backgroundColor = "rgba(255, 255, 255, " + dotCompletion + ")";
                    } else if (i > dotIndex) {
                        dot.style.backgroundColor = "rgba(255, 255, 255, 0.4)";
                    } else {
                        dot.style.backgroundColor = "rgba(255, 255, 255, 1)";
                    }
                }
            }
        }
    }

    function hideLyrics() {
        let mainContainer = document.getElementById("main-container");
        mainContainer.classList.remove("lyrics-visible");
    }

    function showLyrics() {
        let mainContainer = document.getElementById("main-container");
        mainContainer.classList.add("lyrics-visible");
    }

    let SPOTIFY_POLL_RATE = 1000

    let lastRecognizedPlaytime = -1;
    let lastLastRecognizedPlaytime = -1;
    let lastManualPlaytimeChange = -1;

    let lastTimeUpdated = -1;
    let waitingOnLyrics = false;

    let targetTitle = ""
    let targetMetadata = ""

    function stepInputTowardTarget(element, target) {
        let current = element.textContent;
        if (current == target) {
            return;
        }
        if (target.startsWith(current)) {
            element.innerText = target.substring(0, current.length + 1);
        } else {
            element.textContent = current.substring(0, current.length - 1);
        }
    }

    setInterval(() => {
        let titleElement = document.getElementById("title");
        let metadataElement = document.getElementById("metadata");

        stepInputTowardTarget(titleElement, targetTitle);
        stepInputTowardTarget(metadataElement, targetMetadata);
    }, 50);

    function playSong(song_id, title, album, artist, current_time, total_time, album_art_src) {
        targetTitle = title;
        targetMetadata = (artist == null || album == null) ? "" : `${artist} — ${album}`;
        // document.getElementById("title").innerText = title;
        // if (artist == null || album == null) {
        //     document.getElementById("metadata").innerText = "";
        // } else {
        //     document.getElementById("metadata").innerText = `${artist} — ${album}`;
        // }
        
        if (current_time == null || total_time == null) {
            document.getElementById("progress-times").children[0].innerText = "--:--";
            document.getElementById("progress-times").children[1].innerText = "--:--";
            document.getElementById("progress-bar").children[0].style.width = "0%";
        } else {
            let minutes = Math.floor(current_time / 60000);
            let seconds = ((current_time % 60000) / 1000).toFixed(0);
            if (seconds < 10) {
                seconds = `0${seconds}`;
            }
            document.getElementById("progress-times").children[0].innerText = `${minutes}:${seconds}`;

            minutes = Math.floor(total_time / 60000);
            seconds = ((total_time % 60000) / 1000).toFixed(0);
            if (seconds < 10) {
                seconds = `0${seconds}`;
            }
            document.getElementById("progress-times").children[1].innerText = `${minutes}:${seconds}`;

            let progress = current_time / total_time * 100;
            document.getElementById("progress-bar").children[0].style.width = `${progress}%`;
        }
        
        if (album_art_src) {
            // document.getElementById("album-art").src = album_art_src;
            document.getElementById(activeAlbumArtId).src = album_art_src;
            if (activeAlbumArtId == "album-art-one") {
                document.getElementById("album-art-two").style.opacity = 0;
                document.getElementById("album-art-one").style.opacity = 1;
            } else {
                document.getElementById("album-art-one").style.opacity = 0;
                document.getElementById("album-art-two").style.opacity = 1;
            }

            initTextures(album_art_src);
        }

        if (song_id != prevSongId) {
            scrollOffset = 0;
            let lyricsView = document.getElementById("lyrics-view"); 
            waitingOnLyrics = true;
            fadeOutLyrics(lyricsView.children);

            prevSongId = song_id;
            if (song_id == null) {
                return;
            }

            console.log("Requesting lyrics for", title, "by", artist);
            title = encodeURIComponent(title);
            artist = encodeURIComponent(artist);

            // remove / from title and artist
            title = title.replace(/\//g, " ");
            artist = artist.replace(/\//g, " ");
            
            fetch(`https://ytm.nwvbug.com/request-lyrics/${title} [By] ${artist}`).then(text => {
                if (text.status >= 500) {
                    return "no_lyrics_found"
                }
                return text.text()

                // the server is down so I will use cached data
                // return `{"lrc":[{"text":"\u266a","time":0.0},{"text":"She was a stoner","time":6.68},{"text":"And I'm a good boy","time":8.46},{"text":"A loner, but she's a socialite","time":11.33},{"text":"From Minnesota","time":15.17},{"text":"Sipping on rum and soda","time":16.47},{"text":"So sweet like Coca\u2014Cola","time":18.35},{"text":"Oh, my","time":19.96},{"text":"And I don't know what she sees in me","time":22.16},{"text":"We're opposites in ecstasy","time":25.85},{"text":"So call me dumb or just lucky","time":29.46},{"text":"But I forget to breathe, uh","time":32.82},{"text":"I feel like I could die right here","time":35.79},{"text":"Kiss you on the neck, and shed a single tear","time":38.73},{"text":"No one would notice if we disappeared","time":42.25},{"text":"Romantic, hopeless","time":45.94},{"text":"I could die right here","time":47.78},{"text":"Ah\u2014ah\u2014ah\u2014ah\u2014ooh (ooh, ooh, die, I could die right here)","time":49.33},{"text":"Ah\u2014ah\u2014ah\u2014ooh (ooh, ooh, die, I could die right here)","time":53.32},{"text":"Ah\u2014ah\u2014ah\u2014ooh (ooh, ooh, die, I could die right here)","time":57.95},{"text":"Ah\u2014ah\u2014ah\u2014ooh (ooh, ooh, die, I could die right here)","time":61.7},{"text":"I could die right here","time":64.08},{"text":"She looks like fireworks (fireworks)","time":65.97},{"text":"Against a red sky","time":68.62},{"text":"No words (no words)","time":70.53},{"text":"Could ever do her justice","time":72.42},{"text":"My favorite color is her","time":74.22},{"text":"Skin in the summer like gold","time":75.99},{"text":"And cocoa butter","time":77.81},{"text":"Oh, my (oh, my)","time":79.04},{"text":"And I don't know what she sees in me","time":81.17},{"text":"We're opposites in ecstasy (oh, yeah)","time":84.85},{"text":"So call me dumb or just lucky","time":88.52},{"text":"But I forget to breathe, uh","time":92.32},{"text":"I feel like I could die right here","time":95.08},{"text":"Kiss you on the neck, and shed a single tear","time":97.99},{"text":"No one would notice if we disappeared","time":101.1},{"text":"Romantic, hopeless","time":105.13},{"text":"I could die right here","time":106.76},{"text":"(Ah\u2014ah\u2014ah\u2014ah\u2014ooh)","time":108.16},{"text":"I feel like I could die right here, die right here","time":109.7},{"text":"(Ooh) like I could die right here, die right here","time":113.33},{"text":"(Ooh) I'll shed a single tear and disappear, 'cause I could","time":117.18},{"text":"I could die right here","time":123.48}],"source":"ytm"}`
            }).then(text => {
                console.log(text)
            // setTimeout(() => {
            //     text = `{"lrc":[{"text":"\u266a","time":0.0},{"text":"She was a stoner","time":6.68},{"text":"And I'm a good boy","time":8.46},{"text":"A loner, but she's a socialite","time":11.33},{"text":"From Minnesota","time":15.17},{"text":"\u266a","time":16.47},{"text":"So sweet like Coca\u2014Cola","time":18.35},{"text":"Oh, my","time":19.96},{"text":"And I don't know what she sees in me","time":22.16},{"text":"We're opposites in ecstasy","time":25.85},{"text":"So call me dumb or just lucky","time":29.46},{"text":"But I forget to breathe, uh","time":32.82},{"text":"I feel like I could die right here","time":35.79},{"text":"Kiss you on the neck, and shed a single tear","time":38.73},{"text":"No one would notice if we disappeared","time":42.25},{"text":"Romantic, hopeless","time":45.94},{"text":"I could die right here","time":47.78},{"text":"Ah\u2014ah\u2014ah\u2014ah\u2014ooh (ooh, ooh, die, I could die right here)","time":49.33},{"text":"Ah\u2014ah\u2014ah\u2014ooh (ooh, ooh, die, I could die right here)","time":53.32},{"text":"Ah\u2014ah\u2014ah\u2014ooh (ooh, ooh, die, I could die right here)","time":57.95},{"text":"Ah\u2014ah\u2014ah\u2014ooh (ooh, ooh, die, I could die right here)","time":61.7},{"text":"I could die right here","time":64.08},{"text":"She looks like fireworks (fireworks)","time":65.97},{"text":"Against a red sky","time":68.62},{"text":"No words (no words)","time":70.53},{"text":"Could ever do her justice","time":72.42},{"text":"My favorite color is her","time":74.22},{"text":"Skin in the summer like gold","time":75.99},{"text":"And cocoa butter","time":77.81},{"text":"Oh, my (oh, my)","time":79.04},{"text":"And I don't know what she sees in me","time":81.17},{"text":"We're opposites in ecstasy (oh, yeah)","time":84.85},{"text":"So call me dumb or just lucky","time":88.52},{"text":"But I forget to breathe, uh","time":92.32},{"text":"I feel like I could die right here","time":95.08},{"text":"Kiss you on the neck, and shed a single tear","time":97.99},{"text":"No one would notice if we disappeared","time":101.1},{"text":"Romantic, hopeless","time":105.13},{"text":"I could die right here","time":106.76},{"text":"(Ah\u2014ah\u2014ah\u2014ah\u2014ooh)","time":108.16},{"text":"I feel like I could die right here, die right here","time":109.7},{"text":"(Ooh) like I could die right here, die right here","time":113.33},{"text":"(Ooh) I'll shed a single tear and disappear, 'cause I could","time":117.18},{"text":"I could die right here","time":123.48}],"source":"ytm"}`
                if (text == "no_lyrics_found") {
                    waitingOnLyrics = false;
                    hideLyrics();
                    return;
                }
                result = JSON.parse(text)
                if (result.source != "ytm") {
                    console.log(result.source)
                    console.log("Lyrics not found")
                    waitingOnLyrics = false;
                    hideLyrics();
                    return;
                }
                if (lyricsEnabled) {
                    showLyrics();
                }
                setTimeout(() => {
                    fillInLyrics(result.lrc)
                    waitingOnLyrics = false;
                }, 500);
            });
        }
        if (Date.now() - lastManualPlaytimeChange < 1000) {
            return
        }
        lastLastRecognizedPlaytime = lastRecognizedPlaytime;
        lastRecognizedPlaytime = current_time;
        lastTimeUpdated = Date.now();
    }

    function estimateCurrentTime() {
        let estimatedCurrentTime = lastRecognizedPlaytime / 1000
        if (lastRecognizedPlaytime != lastLastRecognizedPlaytime) {
            estimatedCurrentTime += (Date.now() - lastTimeUpdated) / 1000;
        }
        return estimatedCurrentTime;
    }

    function updateLyrics() {
        if (waitingOnLyrics) {
            return;
        }
        scrollLyrics(estimateCurrentTime());
        return;


        let lyricsView = document.getElementById("lyrics-view");
        let nextLyric = lyricsView.children[currentLyricIndex + 1];
        if (nextLyric) {
            while (parseFloat(nextLyric.getAttribute("data-start")) < estimatedCurrentTime) {
                currentLyricIndex++;
                nextLyric = lyricsView.children[currentLyricIndex + 1];
                if (!nextLyric) {
                    break;
                }
            }
        }

        nextLyric = lyricsView.children[currentLyricIndex - 1];
        if (nextLyric) {
            while (parseFloat(nextLyric.getAttribute("data-start")) > estimatedCurrentTime) {
                currentLyricIndex--;
                nextLyric = lyricsView.children[currentLyricIndex];
                if (!nextLyric) {
                    break;
                }
            }
        }
        scrollToLyric(currentLyricIndex);

        // if the currently selected lyric is a div
        let currentLyric = lyricsView.children[currentLyricIndex];
        console.log(currentLyric.tagName);
        if (currentLyric.tagName != "DIV") {
            return;
        }
        // figure out how long until the next lyric
        let nextLyricStart = parseFloat(lyricsView.children[currentLyricIndex + 1].getAttribute("data-start"));

        let thisLyricStart =  parseFloat(currentLyric.getAttribute("data-start"));
        let timeUntilNextLyric = nextLyricStart - estimatedCurrentTime;
        let totalLyricTime = nextLyricStart - thisLyricStart;

        let percentageComplete = 1 - (timeUntilNextLyric / totalLyricTime);

        let dotIndex = Math.floor(percentageComplete * 3);
        let dotCompletion = percentageComplete * 3 - dotIndex;

        for (let i = 0; i < 3; i++) {
            let dot = currentLyric.children[i];
            if (i == dotIndex) {
                dotCompletion = dotCompletion * 0.6 + 0.4;
                dot.style.backgroundColor = "rgba(255, 255, 255, " + dotCompletion + ")";
            } else if (i > dotIndex) {
                dot.style.backgroundColor = "rgba(255, 255, 255, 0.4)";
            } else {
                dot.style.backgroundColor = "rgba(255, 255, 255, 1)";
            }
        }

    }

    setInterval(() => {
        updateLyrics();
    }, 50);


    async function getCurrentlyPlaying() {
        const token = localStorage.getItem('access_token'); // Retrieve the access token from localStorage

        const response = await fetch('https://api.spotify.com/v1/me/player/currently-playing', {
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${token}`, // Pass the access token as a Bearer token
                'Content-Type': 'application/json'
            }
        })
        .then(response => {
            if (response.status === 401) {
                console.log('Token expired. Redirecting to sign in page.');
                signInToSpotify();
            }
            if (response.status === 204) {
                console.log('No track is currently playing.');
                return null;
            }
            return response.json();
        })
        .then(data => {
            if (data) {
                let currentlyPlaying = {
                    songId: data.item.id,
                    songName: data.item.name,
                    artistName: data.item.artists.map(artist => artist.name).join(', '),
                    albumName: data.item.album.name,
                    albumArtUrl: data.item.album.images[0]?.url || null,
                    currentPlaybackTime: data.progress_ms,
                    totalSongLength: data.item.duration_ms
                };
                return currentlyPlaying;
            } else {
                return null;
            }
        })
        
        return response;
    }

    async function togglePlayback() {
        const token = localStorage.getItem('access_token');
        
        const stateRes = await fetch('https://api.spotify.com/v1/me/player', {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        const state = await stateRes.json();
        const endpoint = state.is_playing ? 
            'https://api.spotify.com/v1/me/player/pause' : 
            'https://api.spotify.com/v1/me/player/play';
        await fetch(endpoint, {
            method: 'PUT',
            headers: { 'Authorization': `Bearer ${token}` }
        });
        return !state.is_playing;
    }

    async function skipToPosition(positionMs) {
        const token = localStorage.getItem('access_token');
        await fetch(`https://api.spotify.com/v1/me/player/seek?position_ms=${positionMs}`, {
            method: 'PUT',
            headers: { 'Authorization': `Bearer ${token}` }
        });
    }

    async function skipToNext() {
        const token = localStorage.getItem('access_token');
        await fetch('https://api.spotify.com/v1/me/player/next', {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${token}` }
        });
    }

    async function skipToPrevious() {
        const token = localStorage.getItem('access_token');
        await fetch('https://api.spotify.com/v1/me/player/previous', {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${token}` }
        });
    }

    connect()
</script>
<script type="text/javascript">
    let gl;
    let sId;
    let vBuff;
    let iBuff;
    let timer = 0;

    let targetTexture = 0;
    let blendAmount = 0;

    function initWebGL() {
        let canvas = document.getElementById("glcanvas");
        gl = canvas.getContext("webgl2")
        gl.clearColor(0.0, 0.0, 0.0, 1.0);
        gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);
        initShaderProgram();
        initBuffers();
    }

    function initShaderProgram() {
        sId = gl.createProgram();
        let vertId = gl.createShader(gl.VERTEX_SHADER);
        let fragId = gl.createShader(gl.FRAGMENT_SHADER);
        let vert = document.getElementById("vertScript").text;
        let frag = document.getElementById("fragScript").text;

        gl.shaderSource(vertId, vert);
        gl.shaderSource(fragId, frag);
        gl.compileShader(vertId);
        gl.compileShader(fragId);
        if (!gl.getShaderParameter(vertId, gl.COMPILE_STATUS)) {
            alert("Vertex Shader Compiler Error: " + gl.getShaderInfoLog(vertId));
            gl.deleteShader(vertId);
            return;
        }
        if (!gl.getShaderParameter(fragId, gl.COMPILE_STATUS)) {
            alert("Fragment Shader Compiler Error: " + gl.getShaderInfoLog(fragId));
            gl.deleteShader(fragId);
            return;
        }
        gl.attachShader(sId, vertId);
        gl.attachShader(sId, fragId);
        gl.linkProgram(sId);
        if (!gl.getProgramParameter(sId, gl.LINK_STATUS)) {
            alert("Shader Linking Error: " + gl.getProgramInfoLog(sId));
        }
    }

    function initBuffers() {
        let vertices = new Float32Array([
            // Position (xyz)    // UV coordinates (xy)
            -1.0, -1.0, 0.0,    0.0, 0.0,
            -1.0,  1.0, 0.0,    0.0, 1.0,
            1.0,  1.0, 0.0,    1.0, 1.0,
            1.0, -1.0, 0.0,    1.0, 0.0
        ]);
        let indices = new Uint16Array([0, 1, 3, 2]);
        vBuff = gl.createBuffer()
        gl.bindBuffer(gl.ARRAY_BUFFER, vBuff);
        gl.bufferData(gl.ARRAY_BUFFER, vertices, gl.STATIC_DRAW);
        iBuff = gl.createBuffer();
        gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, iBuff);
        gl.bufferData(gl.ELEMENT_ARRAY_BUFFER, indices, gl.STATIC_DRAW);
    }

    function initTextures(album_art_src) {
        if (activeTexture == "u_texture_one") {
            activeTexture = "u_texture_two";
            activeAlbumArtId = "album-art-two";
        } else {
            activeTexture = "u_texture_one";
            activeAlbumArtId = "album-art-one";
        }

        console.log("Loading texture: ", album_art_src);
        console.log("Active texture: ", activeTexture);


        let newImage = document.createElement("img");
        newImage.setAttribute("crossorigin", "anonymous");
        newImage.src = album_art_src;
        newImage.onload = function () {
            let canvas = document.createElement("canvas")
            let ctx = canvas.getContext("2d");
            ctx.imageSmoothingEnabled = false;
            canvas.width = 40;
            canvas.height = 40;
            ctx.drawImage(newImage, 0, 0, canvas.width, canvas.height);

            canvas = pixelSortH(canvas);
            canvas = pixelSortV(canvas);
            

            let textureUnit = activeTexture === "u_texture_one" ? gl.TEXTURE0 : gl.TEXTURE1;
            let textureUnitIndex = activeTexture === "u_texture_one" ? 0 : 1;

            let uMainTex = gl.getUniformLocation(sId, activeTexture);
            gl.activeTexture(textureUnit);
            gl.uniform1i(uMainTex, textureUnitIndex);

            const texture = gl.createTexture();
            gl.bindTexture(gl.TEXTURE_2D, texture);
            gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.REPEAT);
            gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.REPEAT);
            gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.LINEAR);
            gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.LINEAR);
            gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, gl.RGBA, gl.UNSIGNED_BYTE, canvas);

            targetTexture = Math.abs(1 - textureUnitIndex);
        };
    }
    
    window.requestAnimFrame = (function () {
        return window.requestAnimationFrame ||
            function (callback) {
                window.setTimeout(callback, 1000 / 60);
            };
    })();


    function animationLoop() {
        requestAnimFrame(animationLoop);
        render();
    }

    function render() {
        timer += 0.1;
        gl.useProgram(sId);

        let timeID = gl.getUniformLocation(sId, "u_time");
        gl.uniform1f(timeID, timer / 100);

        let resId = gl.getUniformLocation(sId, "u_resolution");
        let canvasBox = gl.canvas.getBoundingClientRect();
        gl.uniform2f(resId, canvasBox.width, canvasBox.height);

        let attId = gl.getAttribLocation(sId, "position");
        gl.enableVertexAttribArray(attId);
        gl.bindBuffer(gl.ARRAY_BUFFER, vBuff);
        gl.vertexAttribPointer(attId, 3, gl.FLOAT, false, 5 * 4, 0);

        let uvId = gl.getAttribLocation(sId, "texCoord");
        gl.enableVertexAttribArray(uvId);
        gl.vertexAttribPointer(uvId, 2, gl.FLOAT, false, 5 * 4, 3 * 4); // offset is 3 floats * 4 bytes

        let blendAmountId = gl.getUniformLocation(sId, "blend_amount");
        gl.uniform1f(blendAmountId, blendAmount);

        if (targetTexture == 0 && blendAmount > 0) {
            blendAmount -= 0.02;
            if (blendAmount < 0) {
                blendAmount = 0;
            }
        }
        if (targetTexture == 1 && blendAmount < 1) {
            blendAmount += 0.02;
            if (blendAmount > 1) {
                blendAmount = 1;
            }
        }

        gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, iBuff);
        gl.drawElements(gl.TRIANGLE_STRIP, 4, gl.UNSIGNED_SHORT, 0);
    }

    function start() {
        initWebGL();
        animationLoop();
        fixSize();
    }

    function fixSize() {
        let canvas = document.getElementById("glcanvas");
        canvas.width = canvas.getBoundingClientRect().width;
        canvas.height = canvas.getBoundingClientRect().height;
        gl.viewport(0, 0, canvas.width, canvas.height);
    }

    window.onresize = fixSize;

    let lastMouseMove = 0;
    window.onmousemove = function (event) {
        lastMouseMove = Date.now();
        let metadata = document.getElementById("metadata");
        let title = document.getElementById("title");
        let playbackControls = document.getElementById("playback-controls");
        metadata.style.opacity = 0;
        title.style.opacity = 0;
        playbackControls.style.opacity = 1;
        setTimeout(() => {
            checkRestoreMetadata()
        }, 3001);
    }

    function checkRestoreMetadata() {
        let metadata = document.getElementById("metadata");
        let title = document.getElementById("title");
        let playbackControls = document.getElementById("playback-controls");
        if (Date.now() - lastMouseMove < 3000) {
            return
        }
        metadata.style.opacity = 1;
        title.style.opacity = 1;
        playbackControls.style.opacity = 0;

    }
</script>
<script>
    const threshold = 0;
    const vertical = false;
    const invert = false;

    // Stolen from here http://feiss.github.io/pixelsorting/
    function pixelSortH(canvas){
        let c = canvas.getContext('2d');
        let b = canvas
        for(var row= 0; row< b.height; row++){
            var imdata = c.getImageData(0, row, b.width, 1);
            var data = imdata.data;

            var pixels= getPixelsArray(data);
            
            var start= 0;
            var end = findValueLess(pixels, row, threshold, start);
            while (start<b.width) {
                var range= pixels.splice(start, end-start);
                range.sort(invert?simpleMeanSortInverted:simpleMeanSort);
                pixels.splice.apply(pixels, [start,0].concat(range));
                
                start= end;
                end= findValueLess(pixels, row, threshold, start+1);
            }
            setDataFromPixelsArray(data, pixels);
            c.putImageData(imdata, 0, row);
        }
        return b;
    }

    function pixelSortV(canvas) {
        let c = canvas.getContext('2d');
        let b = canvas;
        for(var col= 0; col< b.width; col++){
            var imdata= c.getImageData(col, 0, 1, b.height);
            var data= imdata.data;

            var pixels= getPixelsArray(data);
            
            var start= 0;
            var end= findValueLess(pixels, col, threshold, start);
            while(start<b.height){
                var range= pixels.splice(start, end-start);
                range.sort(invert?simpleMeanSortInverted:simpleMeanSort);
                pixels.splice.apply(pixels, [start,0].concat(range));
                
                start= end;
                end= findValueLess(pixels, col, threshold, start+1);
            }
                
            setDataFromPixelsArray(data, pixels);
            c.putImageData(imdata, col, 0);
        }
        return b;
    }

    function getPixelsArray(data){
        var p= [], c;
        for (var i = 0; i < data.length/4; i++) {
            c= i*4;
            p.push({r: data[c+0], g: data[c+1], b: data[c+2]});
        };
        return p;
    }

    function simpleMeanSort(a,b){
        var aa= (a.r+a.g+a.b)/3;
        var bb= (b.r+b.g+b.b)/3;
        return aa<bb?-1: (aa>bb?1:0);
    }
    function simpleMeanSortInverted(a,b){
        var aa= (a.r+a.g+a.b)/3;
        var bb= (b.r+b.g+b.b)/3;
        return aa>bb?-1: (aa<bb?1:0);
    }

    function setDataFromPixelsArray(data, pixels){
        var c;
        for (var i = 0; i < pixels.length; i++) {
            c= i*4;
            data[c+0]= pixels[i].r;
            data[c+1]= pixels[i].g;
            data[c+2]= pixels[i].b;
        }
    }

    function findValue(pixels, row, val, start){
        for (var i=start; i< pixels.length; i++){
            if (pixels[i].r==val.r && pixels[i].g==val.g && pixels[i].b==val.b) {
                return i;
            }
        }
        return pixels.length;
    }

    function findValueLess(pixels, row, val, start){
        for (var i=start; i< pixels.length; i++){
            if ((pixels[i].r+pixels[i].g+pixels[i].b)/3 < val) {
                return i;
            }
        }
        return pixels.length;
    }
</script>
<script id="vertScript" type="x-shader/x-vertex">#version 300 es
    layout(location = 0) in vec3 position;
    layout(location = 1) in vec2 texCoord;
    
    out vec2 uv;  // Pass texture coordinates to the fragment shader
    
    void main() {
        uv = texCoord;
        gl_Position = vec4(position, 1.0);
    }
</script>
<script id="fragScript" type="x-shader/x-fragment">#version 300 es
    precision highp float;
    precision highp sampler2D;
    
    // normalized coordinates, (0,0) is the bottom left
    in vec2 uv;
    // resulting fragment color, you may name it whatever you like
    out vec4 out_color;
    
    // @note you can hover over symbols, variables, struct types and functions for more info
    
    // size of the canvas in pixels
    uniform vec2 u_resolution;
    // elapsed time since shader compile in seconds
    uniform float u_time;
    // mouse pixel coordinates are in canvas space, (0,0) is top left
    uniform vec4 u_mouse;
    // texture array
    uniform sampler2D u_texture_one;
    uniform sampler2D u_texture_two;
    uniform float blend_amount;
    

    float rand(vec2 c){
        return fract(sin(dot(c.xy ,vec2(12.9898,78.233))) * 43758.5453);
    }
    
    float noise(vec2 p, float freq ){
        float unit = 1.;
        vec2 ij = floor(p/unit);
        vec2 xy = mod(p,unit)/unit;
        //xy = 3.*xy*xy-2.*xy*xy*xy;
        xy = .5*(1.-cos(3.1415*xy));
        float a = rand((ij+vec2(0.,0.)));
        float b = rand((ij+vec2(1.,0.)));
        float c = rand((ij+vec2(0.,1.)));
        float d = rand((ij+vec2(1.,1.)));
        float x1 = mix(a, b, xy.x);
        float x2 = mix(c, d, xy.x);
        return mix(x1, x2, xy.y);
    }
    
    float pNoise(vec2 p, int res){
        float persistance = .5;
        float n = 0.;
        float normK = 0.;
        float f = 4.;
        float amp = 1.;
        int iCount = 0;
        for (int i = 0; i<50; i++){
            n+=amp*noise(p, f);
            f*=2.;
            normK+=amp;
            amp*=persistance;
            if (iCount == res) break;
            iCount++;
        }
        float nf = n/normK;
        return nf*nf*nf*nf;
    }

    float normalizedSine(float t) {
        return (sin(t) + 1.) / 2.;
    }




    float curveEquation(float uv_y) {
        float sinWave = -sin(uv_y * (normalizedSine(u_time) + 0.5) * 4.) / 3.;
        float linear = sin(uv_y * (normalizedSine(u_time) + 0.5) * 4.) / 3.;
    
        float blendAmount = (sin(u_time * 1.4) + 1.) / 2.;
        // float blendAmount = 1.;
        sinWave = sinWave * blendAmount + (linear * (1. - blendAmount));
    
        sinWave += cos(uv.x * 4.35 + u_time) * 0.1;
        sinWave += cos(uv.x * 6.51 + u_time) * 0.05;
        return sinWave;
    }
    
    vec3 colorRamp(float t, vec3 colors[5]) {
        t = fract(t - 0.1);
        t = 1.0 - abs(2.0 * t - 1.0);
        t *= 4.0;
        
        vec3 finalColor = vec3(0.0);
        float totalWeight = 0.0;
        
        for(int i = 0; i < 5; i++) {
            float dist = abs(float(i) - t);
            float weight = 1.0 - smoothstep(0.0, 3.0, dist);
            finalColor += colors[i] * weight;
            totalWeight += weight;
        }
        
        return finalColor / totalWeight;
    }

    vec3 blendTextureSample(vec2 uv) {
        return mix(texture(u_texture_one, uv).rgb, texture(u_texture_two, uv).rgb, 1. - blend_amount);
    }
    
    void main(){
        vec2 sample_point = vec2(uv.x - 0.5, uv.y - 0.5);
        // float power = ((sin(u_time + (uv.y * 5.)) + 1.) / 2.) + 0.7;
        float power = normalizedSine(u_time + (uv.y * 5.)) * 1. + 0.3;
        // float power = 0.1;
        float val = (sample_point.x - curveEquation(sample_point.y));

        float isNeg = sign(val);
        float col = pow(abs(val), power) + 0.5;
        col = col * isNeg;

        //float signVal = sign(sin(u_time * 0.25));
        //if (signVal < 0.) {
        //    col = 1. - col;
        //} else {
        //    col = col;
        //}
        //col *= abs(sin(u_time * 0.25));
        // col += sin(u_time * 1.95) / 3.;

        col += sin(u_time + (sin(u_time) * uv.x) + (cos(u_time) * uv.y)) / 2.;
        // if (col > 1.) {
        //     col = 2. - col;
        // }
        // if (val < 0.) {
        //     col = abs(col);
        // }

        if (val < 0.01 && val > -0.01) {
            // out_color = vec4(1., 0., 0., 1.);
            // return;
        }

        // col *= 0.5;
        col += u_time * 0.5;
        col += pNoise(uv * 10., 5) * 0.05;
        
        //vec3 colors[5] = vec3[5](
        //    blendTextureSample(vec2(0.1, 0.1)),
        //    blendTextureSample(vec2(0.3, 0.3)),
        //    blendTextureSample(vec2(0.5, 0.5)),
        //    blendTextureSample(vec2(0.7, 0.7)),
        //    blendTextureSample(vec2(0.9, 0.9))
        //);
        vec3 colors[5] = vec3[5](
            blendTextureSample(vec2(0.5 + 0.4 * cos(u_time + 0.0 * 6.28), 0.5 + 0.4 * sin(u_time + 0.0 * 6.28))),
            blendTextureSample(vec2(0.5 + 0.4 * cos(u_time + 0.2 * 6.28), 0.5 + 0.4 * sin(u_time + 0.2 * 6.28))),
            blendTextureSample(vec2(0.5 + 0.4 * cos(u_time + 0.4 * 6.28), 0.5 + 0.4 * sin(u_time + 0.4 * 6.28))),
            blendTextureSample(vec2(0.5 + 0.4 * cos(u_time + 0.6 * 6.28), 0.5 + 0.4 * sin(u_time + 0.6 * 6.28))),
            blendTextureSample(vec2(0.5 + 0.4 * cos(u_time + 0.8 * 6.28), 0.5 + 0.4 * sin(u_time + 0.8 * 6.28)))
        );
        out_color = vec4(colorRamp(col, colors), 1);
    
    }
</script>
</html>